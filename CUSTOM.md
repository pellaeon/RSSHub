# RSSHub with enhanced Facebook crawling

## Special setup

1. Set environment variables:

```
export PROXY_URI="http://aproxy.tw:3128"
export NODE_NAME=rsshub.example.com
```

- Proxy is required to circumvent Facebook's aggressive rate limiting
- NODE_NAME is used to replace images served from Facebook CDN to be served from the local server

2. `npm start`

3. Nginx config example:

```
# 1 is allowed
geo $whitelist {
	default					0;
	1.2.3.4/32      		1;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name rsshub.example.com;

	access_log /var/log/nginx/rsshub.access.log;
	error_log /var/log/nginx/rsshub.error.log;

    root /var/www/html;
    # only requests from whitelisted IPs are passed to rsshub, otherwise a cache at /var/www/rsshub is served
	location / {
		root               /var/www/rsshub;
		if ($whitelist) {
			error_page         405 = @fetch;
			return 405;
		}
		try_files $uri =404;
	}

    # proxy_store is used, all paths generated by rsshub will be cached by nginx in /var/www/rsshub
	location @fetch {
		internal;

        proxy_pass http://localhost:1200;
        proxy_redirect     off;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header   Host $host;
		proxy_store        on;
		proxy_store_access user:rw group:rw all:r;
		proxy_temp_path    /tmp/;

		root               /var/www/rsshub;
	}

    # My custom facebook route will fetch images from facebook CDN and store it here,
    # because the img src served from mbasic will expire in a few days
	location /pics/ {
		alias /var/www/rsshub/pics/;
	}

    ssl_certificate /etc/letsencrypt/live/rsshub.example.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/rsshub.example.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}
```
